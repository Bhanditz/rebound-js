!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.rebound=i()}(this,function(){"use strict";function t(t){return a(t)}function i(t,i){var e=t.indexOf(i);-1!=e&&t.splice(e,1)}function e(t){if(l[t])return l[t];3===(t=t.replace("#","")).length&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);var i=t.match(/.{2}/g);if(!i||i.length<3)throw new Error("Expected a color string of format #rrggbb");var e={r:parseInt(i[0],16),g:parseInt(i[1],16),b:parseInt(i[2],16)};return l[t]=e,e}function n(t,i,e){var n=t.toString(16),r=i.toString(16),s=e.toString(16);return n=n.length<2?"0"+n:n,r=r.length<2?"0"+r:r,s=s.length<2?"0"+s:s,"#"+n+r+s}function r(t,i,e,n,r){return n+(t-i)/(e-i)*(r-n)}function s(t){return 3.62*(t-30)+194}function o(t){return 3*(t-8)+25}function h(){if(null==this.springSystem)throw new Error("cannot run looper without a springSystem");return this.springSystem}var p;"undefined"!=typeof window&&(p=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame),p||"undefined"==typeof process||"node"!==process.title||(p=setImmediate);var a=p=p||function(t){window.setTimeout(t,1e3/60)},u=Array.prototype.concat,c=Array.prototype.slice,l={},g=Object.freeze({bind:function(t,i){var e=c.call(arguments,2);return function(){t.apply(i,u.call(e,c.call(arguments)))}},extend:function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])},onFrame:t,removeFirst:i,hexToRGB:e,rgbToHex:n}),f=Object.freeze({mapValueInRange:r,interpolateColor:function(t,i,s,o,h,p){o=void 0===o?0:o,h=void 0===h?1:h;var a=e(i),u=e(s),c=Math.floor(r(t,o,h,a.r,u.r)),l=Math.floor(r(t,o,h,a.g,u.g)),g=Math.floor(r(t,o,h,a.b,u.b));return p?"rgb("+c+","+l+","+g+")":n(c,l,g)},degreesToRadians:function(t){return t*Math.PI/180},radiansToDegrees:function(t){return 180*t/Math.PI}}),_=Object.freeze({tensionFromOrigamiValue:s,origamiValueFromTension:function(t){return(t-194)/3.62+30},frictionFromOrigamiValue:o,origamiFromFriction:function(t){return(t-25)/3+8}}),S=function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")},d=Object.assign||function(t){for(var i=1;i<arguments.length;i++){var e=arguments[i];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t},m=function(){function i(){S(this,i),this.springSystem=null}return i.prototype.run=function(){var i=h.call(this);t(function(){i.loop(Date.now())})},i}(),y=function(){function t(i){S(this,t),this.springSystem=null,this.time=0,this.running=!1,this.timestep=i||16.667}return t.prototype.run=function(){var t=h.call(this);if(!this.running){for(this.running=!0;!t.getIsIdle();)t.loop(this.time+=this.timestep);this.running=!1}},t}(),v=function(){function t(){S(this,t),this.springSystem=null,this.time=0,this.running=!1}return t.prototype.run=function(){},t.prototype.step=function(t){h.call(this).loop(this.time+=t)},t}(),E=Object.freeze({AnimationLooper:m,SimulationLooper:y,SteppingSimulationLooper:v}),I=function(){function t(i,e){S(this,t),this.bounciness=i,this.speed=e;var n=this.normalize(i/1.7,0,20);n=this.projectNormal(n,0,.8);var r=this.normalize(e/1.7,0,20);this.bouncyTension=this.projectNormal(r,.5,200),this.bouncyFriction=this.quadraticOutInterpolation(n,this.b3Nobounce(this.bouncyTension),.01)}return t.prototype.normalize=function(t,i,e){return(t-i)/(e-i)},t.prototype.projectNormal=function(t,i,e){return i+t*(e-i)},t.prototype.linearInterpolation=function(t,i,e){return t*e+(1-t)*i},t.prototype.quadraticOutInterpolation=function(t,i,e){return this.linearInterpolation(2*t-t*t,i,e)},t.prototype.b3Friction1=function(t){return 7e-4*Math.pow(t,3)-.031*Math.pow(t,2)+.64*t+1.28},t.prototype.b3Friction2=function(t){return 44e-6*Math.pow(t,3)-.006*Math.pow(t,2)+.36*t+2},t.prototype.b3Friction3=function(t){return 4.5e-7*Math.pow(t,3)-332e-6*Math.pow(t,2)+.1078*t+5.84},t.prototype.b3Nobounce=function(t){return t<=18?this.b3Friction1(t):t>18&&t<=44?this.b3Friction2(t):this.b3Friction3(t)},t}(),T=function(){function t(i,e){S(this,t),this.tension=i,this.friction=e}return t.fromOrigamiTensionAndFriction=function(i,e){return new t(s(i),o(e))},t.fromBouncinessAndSpeed=function(i,e){var n=new I(i,e);return t.fromOrigamiTensionAndFriction(n.bouncyTension,n.bouncyFriction)},t.coastingConfigWithOrigamiFriction=function(i){return new t(0,o(i))},t}();T.DEFAULT_ORIGAMI_SPRING_CONFIG=T.fromOrigamiTensionAndFriction(40,7);var A=function t(){S(this,t),this.position=0,this.velocity=0},R=function(){function t(i){S(this,t),this.listeners=[],this._startValue=0,this._currentState=new A,this._displacementFromRestThreshold=.001,this._endValue=0,this._overshootClampingEnabled=!1,this._previousState=new A,this._restSpeedThreshold=.001,this._tempState=new A,this._timeAccumulator=0,this._wasAtRest=!0,this._id="s"+t._ID++,this._springSystem=i}return t.prototype.destroy=function(){this.listeners=[],this._springSystem.deregisterSpring(this)},t.prototype.getId=function(){return this._id},t.prototype.setSpringConfig=function(t){return this._springConfig=t,this},t.prototype.getSpringConfig=function(){return this._springConfig},t.prototype.setCurrentValue=function(t,i){return this._startValue=t,this._currentState.position=t,i||this.setAtRest(),this.notifyPositionUpdated(!1,!1),this},t.prototype.getStartValue=function(){return this._startValue},t.prototype.getCurrentValue=function(){return this._currentState.position},t.prototype.getCurrentDisplacementDistance=function(){return this.getDisplacementDistanceForState(this._currentState)},t.prototype.getDisplacementDistanceForState=function(t){return Math.abs(this._endValue-t.position)},t.prototype.setEndValue=function(t){if(this._endValue==t&&this.isAtRest())return this;this._startValue=this.getCurrentValue(),this._endValue=t,this._springSystem.activateSpring(this.getId());for(var i=0,e=this.listeners.length;i<e;i++){var n=this.listeners[i].onSpringEndStateChange;n&&n(this)}return this},t.prototype.getEndValue=function(){return this._endValue},t.prototype.setVelocity=function(t){return t===this._currentState.velocity?this:(this._currentState.velocity=t,this._springSystem.activateSpring(this.getId()),this)},t.prototype.getVelocity=function(){return this._currentState.velocity},t.prototype.setRestSpeedThreshold=function(t){return this._restSpeedThreshold=t,this},t.prototype.getRestSpeedThreshold=function(){return this._restSpeedThreshold},t.prototype.setRestDisplacementThreshold=function(t){this._displacementFromRestThreshold=t},t.prototype.getRestDisplacementThreshold=function(){return this._displacementFromRestThreshold},t.prototype.setOvershootClampingEnabled=function(t){return this._overshootClampingEnabled=t,this},t.prototype.isOvershootClampingEnabled=function(){return this._overshootClampingEnabled},t.prototype.isOvershooting=function(){var t=this._startValue,i=this._endValue;return this._springConfig.tension>0&&(t<i&&this.getCurrentValue()>i||t>i&&this.getCurrentValue()<i)},t.prototype.advance=function(i,e){var n=this.isAtRest();if(!n||!this._wasAtRest){var r=e;e>t.MAX_DELTA_TIME_SEC&&(r=t.MAX_DELTA_TIME_SEC),this._timeAccumulator+=r;for(var s,o,h,p,a,u,c,l,g=this._springConfig.tension,f=this._springConfig.friction,_=this._currentState.position,S=this._currentState.velocity,d=this._tempState.position,m=this._tempState.velocity;this._timeAccumulator>=t.SOLVER_TIMESTEP_SEC;)this._timeAccumulator-=t.SOLVER_TIMESTEP_SEC,this._timeAccumulator<t.SOLVER_TIMESTEP_SEC&&(this._previousState.position=_,this._previousState.velocity=S),s=S,o=g*(this._endValue-d)-f*S,d=_+s*t.SOLVER_TIMESTEP_SEC*.5,h=m=S+o*t.SOLVER_TIMESTEP_SEC*.5,p=g*(this._endValue-d)-f*m,d=_+h*t.SOLVER_TIMESTEP_SEC*.5,a=m=S+p*t.SOLVER_TIMESTEP_SEC*.5,u=g*(this._endValue-d)-f*m,d=_+a*t.SOLVER_TIMESTEP_SEC,c=m=S+u*t.SOLVER_TIMESTEP_SEC,l=g*(this._endValue-d)-f*m,_+=1/6*(s+2*(h+a)+c)*t.SOLVER_TIMESTEP_SEC,S+=1/6*(o+2*(p+u)+l)*t.SOLVER_TIMESTEP_SEC;this._tempState.position=d,this._tempState.velocity=m,this._currentState.position=_,this._currentState.velocity=S,this._timeAccumulator>0&&this._interpolate(this._timeAccumulator/t.SOLVER_TIMESTEP_SEC),(this.isAtRest()||this._overshootClampingEnabled&&this.isOvershooting())&&(this._springConfig.tension>0?(this._startValue=this._endValue,this._currentState.position=this._endValue):(this._endValue=this._currentState.position,this._startValue=this._endValue),this.setVelocity(0),n=!0);var y=!1;this._wasAtRest&&(this._wasAtRest=!1,y=!0);var v=!1;n&&(this._wasAtRest=!0,v=!0),this.notifyPositionUpdated(y,v)}},t.prototype.notifyPositionUpdated=function(t,i){for(var e=0,n=this.listeners.length;e<n;e++){var r=this.listeners[e];t&&r.onSpringActivate&&r.onSpringActivate(this),r.onSpringUpdate&&r.onSpringUpdate(this),i&&r.onSpringAtRest&&r.onSpringAtRest(this)}},t.prototype.systemShouldAdvance=function(){return!this.isAtRest()||!this.wasAtRest()},t.prototype.wasAtRest=function(){return this._wasAtRest},t.prototype.isAtRest=function(){return Math.abs(this._currentState.velocity)<this._restSpeedThreshold&&(this.getDisplacementDistanceForState(this._currentState)<=this._displacementFromRestThreshold||0===this._springConfig.tension)},t.prototype.setAtRest=function(){return this._endValue=this._currentState.position,this._tempState.position=this._currentState.position,this._currentState.velocity=0,this},t.prototype._interpolate=function(t){this._currentState.position=this._currentState.position*t+this._previousState.position*(1-t),this._currentState.velocity=this._currentState.velocity*t+this._previousState.velocity*(1-t)},t.prototype.getListeners=function(){return this.listeners},t.prototype.addListener=function(t){return this.listeners.push(t),this},t.prototype.removeListener=function(t){return i(this.listeners,t),this},t.prototype.removeAllListeners=function(){return this.listeners=[],this},t.prototype.currentValueIsApproximately=function(t){return Math.abs(this.getCurrentValue()-t)<=this.getRestDisplacementThreshold()},t}();R._ID=0,R.MAX_DELTA_TIME_SEC=.064,R.SOLVER_TIMESTEP_SEC=.001;var V=function(){function t(i){S(this,t),this._springRegistry={},this._activeSprings=[],this.listeners=[],this._idleSpringIndices=[],this._isIdle=!0,this._lastTimeMillis=-1,this.looper=i||new m,this.looper.springSystem=this}return t.prototype.setLooper=function(t){this.looper=t,t.springSystem=this},t.prototype.createSpring=function(t,i){var e;return e=void 0===t||void 0===i?T.DEFAULT_ORIGAMI_SPRING_CONFIG:T.fromOrigamiTensionAndFriction(t,i),this.createSpringWithConfig(e)},t.prototype.createSpringWithBouncinessAndSpeed=function(t,i){var e;return e=void 0===t||void 0===i?T.DEFAULT_ORIGAMI_SPRING_CONFIG:T.fromBouncinessAndSpeed(t,i),this.createSpringWithConfig(e)},t.prototype.createSpringWithConfig=function(t){var i=new R(this);return this.registerSpring(i),i.setSpringConfig(t),i},t.prototype.getIsIdle=function(){return this._isIdle},t.prototype.getSpringById=function(t){return this._springRegistry[t]},t.prototype.getAllSprings=function(){var t=[];for(var i in this._springRegistry)this._springRegistry.hasOwnProperty(i)&&t.push(this._springRegistry[i]);return t},t.prototype.registerSpring=function(t){this._springRegistry[t.getId()]=t},t.prototype.deregisterSpring=function(t){i(this._activeSprings,t),delete this._springRegistry[t.getId()]},t.prototype.advance=function(t,i){for(;this._idleSpringIndices.length>0;)this._idleSpringIndices.pop();for(var e=0,n=this._activeSprings.length;e<n;e++){var r=this._activeSprings[e];r.systemShouldAdvance()?r.advance(t/1e3,i/1e3):this._idleSpringIndices.push(this._activeSprings.indexOf(r))}for(;this._idleSpringIndices.length>0;){var s=this._idleSpringIndices.pop();s>=0&&this._activeSprings.splice(s,1)}},t.prototype.loop=function(t){var i;-1===this._lastTimeMillis&&(this._lastTimeMillis=t-1);var e=t-this._lastTimeMillis;this._lastTimeMillis=t;var n=0,r=this.listeners.length;for(n=0;n<r;n++)(i=this.listeners[n]).onBeforeIntegrate&&i.onBeforeIntegrate(this);for(this.advance(t,e),0===this._activeSprings.length&&(this._isIdle=!0,this._lastTimeMillis=-1),n=0;n<r;n++)(i=this.listeners[n]).onAfterIntegrate&&i.onAfterIntegrate(this);this._isIdle||this.looper.run()},t.prototype.activateSpring=function(t){var i=this._springRegistry[t];-1==this._activeSprings.indexOf(i)&&this._activeSprings.push(i),this.getIsIdle()&&(this._isIdle=!1,this.looper.run())},t.prototype.addListener=function(t){this.listeners.push(t)},t.prototype.removeListener=function(t){i(this.listeners,t)},t.prototype.removeAllListeners=function(){this.listeners=[]},t}();return d({},E,{OrigamiValueConverter:_,MathUtil:f,Spring:R,SpringConfig:T,SpringSystem:V,util:d({},g,f)})});